<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Tube</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            background-color: #000000;
            color: #ff9729;
            text-align: center;
            margin: 0;
            padding: 0;
            font-weight: 400;
            line-height: 1.5;
            font-size: 1.4em;

        }

        .station-name {
            font-weight: bold;
        }

        .time-left {
            color: red;
        }

        #arrivals {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            padding: 0;
            margin: 0;
        }


        .platform-section {
            padding: 10px;
            border-radius: 10px;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 15px;
            border-radius: 10px;
            overflow: hidden;
        }

        .platform-section h3 {
            color: red;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin: 0;
            color: white;
        }

        .arrival-time {
            padding: 10px;
            background-color: #000;
            border-bottom: 1px solid #555;
            margin: 5px 0;
            letter-spacing: 1px;
            text-align: left;
        }

        .arrival-time p {
            font-weight: bold;
            margin: 5px 0;
            line-height: 1.5;
            padding: 10px;
            background-color: #000;
            margin: 5px 0;
            letter-spacing: 1px;
            text-align: left;
        }

        .live-location {

            font-weight: light;
            color: green;
        }

        .departure {
            display: flex;
            justify-content: space-between;
        }

        .departure p {
            margin: 0;
            padding: 0;
        }

        #journeyContainer {

            display: flex;
        }

        .journey {
            padding: 10px;
            text-align: left;
            font-size: 1em;
        }

        @media (max-width: 900px) {


            #journeyContainer {

                display: grid;
                grid-template-columns: 1fr;
            }
        }




        @media (max-width: 768px) {

            #arrivals {
                grid-template-columns: 1fr;
            }


            #journeyContainer {

                display: grid;
                grid-template-columns: 1fr;
            }

        }
    </style>
</head>

<body>
    <div>
        <span class="station-name">Stepney Green</span>
        <span id="clock" style="color: red; font-weight:bold;"></span>
    </div>
    <div id="arrivals"></div>
    <div id="journeyContainer"></div>

    <script>


        // Function to update the live clock
        function updateClock() {
            const now = new Date();
            const clockElement = document.getElementById('clock');
            clockElement.textContent = now.toLocaleTimeString();
        }
        setInterval(updateClock, 1000); // Update clock every second



        // Fetch the live data every 30 seconds
        function fetchArrivals() {
            fetch('https://api.tfl.gov.uk/StopPoint/940GZZLUSGN/arrivals')
                .then(response => response.json())
                .then(data => {
                    updateArrivals(data);
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        // Function to update arrival times on the page
        function updateArrivals(data) {
            const arrivalsContainer = document.getElementById('arrivals');
            arrivalsContainer.innerHTML = ''; // Clear previous data

            // Sort the data by time left (ascending order)
            const sortedData = data.sort((a, b) => a.timeToStation - b.timeToStation);

            // Group the data by platform
            const platforms = {};

            sortedData.forEach(item => {
                const platform = item.platformName;
                if (!platforms[platform]) {
                    platforms[platform] = [];
                }
                platforms[platform].push(item);
            });

            const sortedPlatforms = Object.keys(platforms).sort((a, b) => {

                return a - b;
            });


            // Create platform sections and display the arrivals
            sortedPlatforms.forEach(platform => {
                const platformSection = document.createElement('div');
                platformSection.classList.add('platform-section');

                const platformHeader = document.createElement('h3');
                platformHeader.textContent = platform;
                platformSection.appendChild(platformHeader);


                platforms[platform].forEach((item, i) => {

                    if (i > 4) {
                        return;
                    }
                    const arrivalDiv = document.createElement('div');
                    arrivalDiv.classList.add('arrival-time');

                    const line = item.lineName || 'Line Unknown';
                    const destination = item.destinationName?.replace("Underground Station", "") || 'Destination Unknown';
                    const currentLocation = item.currentLocation || 'Location Unknown';
                    const timeToStation = Math.floor(item.timeToStation / 60) || 0;
                    const expectedArrival = new Date(item.expectedArrival).toLocaleTimeString();

                    arrivalDiv.innerHTML = ` 
                 <div class="departure">
                   <p class="destination"><span>${destination} - ${expectedArrival}</span></p>
                   <p class="time-left"><span>${timeToStation} mins</span></p>
                 </div>
                 <div class="departure">
                   <p class="live-location">Live: <span>${currentLocation || 'N/A'}</span></p>
                 </div>
               `;

                    platformSection.appendChild(arrivalDiv);
                });

                arrivalsContainer.appendChild(platformSection);
            });
        }


        // Initial data fetch
        fetchArrivals();
        setInterval(fetchArrivals, 20000);  // Fetch data every 30 seconds

    </script>
    <script>
        const API_URL = "https://api.tfl.gov.uk/Journey/JourneyResults/E14AQ/to/marriotcountyhall?mode=bus,tube&walkingSpeed=fast&useRealTimeLiveArrivals=true";

        async function fetchJourneys() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                displayJourneys(data.journeys);
            } catch (error) {
                console.error("Error fetching journey data:", error);
                document.getElementById("journeyContainer").innerHTML = "Failed to load journey data.";
            }
        }

        function displayJourneys(journeys) {
            const container = document.getElementById("journeyContainer");
            container.innerHTML = "";



            if (!journeys || journeys.length === 0) {
                container.innerHTML = "No journeys available.";
                return;
            }

            journeys.forEach(journey => {
                const journeyDiv = document.createElement("div");
                journeyDiv.className = "journey";

                const startTime = new Date(journey.startDateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const arrivalTime = new Date(journey.arrivalDateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                journeyDiv.innerHTML = `
                 
                     <p> <strong> ${startTime} - ${arrivalTime} </strong>  <span class="time-left"> ( ${journey.duration}' )</span></p>
         </h3>
                     <div class="legs">
                         ${journey.legs.map((leg, i) => `
                             <p>â€¢ ${leg.instruction.summary}  ${new Date(leg.departureTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} (${leg.duration}')</p>
                         `).join("")}
                     </div>
                 `;

                container.appendChild(journeyDiv);
            });
        }

        fetchJourneys();
        setInterval(fetchJourneys, 20000);
    </script>

    <div
        style="position: fixed; bottom: 10px; right: 10px; background: #111; padding: 10px; border-radius: 8px; color: white; font-size: 0.4em;">
        <label for="fontSlider">Font Size:</label>
        <input type="range" id="fontSlider" min="1" max="6" step="0.1">
    </div>
    <script>
        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + d.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }

        function getCookie(name) {
            const cname = name + "=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const ca = decodedCookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i].trim();
                if (c.indexOf(cname) === 0) {
                    return c.substring(cname.length, c.length);
                }
            }
            return "";
        }

        // --- Font Size Control ---
        const fontSlider = document.getElementById("fontSlider");

        // Update on slider change
        fontSlider.addEventListener("input", (e) => {
            applyFontSize(e.target.value);
        });


        function applyFontSize(size) {
            document.body.style.fontSize = size + "em";
            setCookie("fontSize", size, 30); // save for 30 days
        }

        // Load saved font size
        addEventListener("DOMContentLoaded", () => {

            let savedSize = getCookie("fontSize");

            if (savedSize) {
                document.body.style.fontSize = savedSize + "em";
                fontSlider.value = savedSize;
            } else {
                fontSlider.value = 1; // default
            }
        });


    </script>
</body>

</html>